<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Posts</title>

             <!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<link rel="stylesheet" href="style.css">
</head>
<body class="d-flex flex-column min-vh-100" >
    <nav class="navabar navbar-expand-lg navbar-dark bg-primary text-white">
        <div class="container">
            <a class="navbar-brand" href="#">BlogD</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
    <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="postDropdown" role="button" data-bs-toggle="dropdown">Post</a>
                 <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="myposts.html">My Posts</a></li>
                    <li><a class="dropdown-item" href="add.html">Add Post</a></li>
                 </ul>
                </li>
                <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="postDropdown" role="button" data-bs-toggle="dropdown">User</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="register.html">Register</a></li>
                        <li><a class="dropdown-item" href="login.html">Login</a></li>
                        <li><a class="dropdown-item text-danger" href="#" id="logout">Logout</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="postDropdown" role="button" data-bs-toggle="dropdown">More</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="settings.html">Settings</a></li>
                        <li><a class="dropdown-item" href="privacy.html">Privacy Policy</a></li>
                        <li><a class="dropdown-item" href="terms.html">Terms Of Agreement</a></li>
                    </ul>
                </li>
            </ul>
          </div>
                </div>
    </nav>

    <div id="message-container" class="container mt-3"></div> 
    
    <div class="container mt-5">
        <h2 class="text-center">My Posts</h2>
        <div id="my-posts-container" class="row mt-4"></div>
    </div>


    
    <footer class="bg-primary text-white text-center py-3 mt-auto">
        <a class="nav-link" href="#">Back to Top &uparrow;</a>
        <p>&copy; 2025 BlogD.All rights reserved.</p>
    </footer>
    
    <!-- Bootstrap JS (for dropdowns, navbar toggle, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
<script src="script.js"></script>

<script>
document.addEventListener("DOMContentLoaded",async()=>{
    const myPostsContainer=document.getElementById("my-posts-container");

    try{
        //Fetch the Loggged-in user
        const sessionResponse=await fetch("/check-session");
        const sessionData=await sessionResponse.json();
        const loggedInUser=sessionData.loggedIn?sessionData.user.id:null;

        if(!sessionData.loggedIn){
            myPostsContainer.innerHTML=`
            <div class="alert alert-warning text-center" role="alert">
                <h4 class='alert-heading'>Please log in to view your posts.</h4>
                </div>`;
            return;
        }

        const loggedInUserId=sessionData.user.id;

        //Fetch only the user's posts
        const response=await fetch("/myposts");
        const posts=await response.json();
      
        myPostsContainer.innerHTML="";

        if(posts.length===0){
            myPostsContainer.innerHTML="<h3 class='text-center'>No posts found.</h3>";
            return;
        }

        posts.forEach(post => {
            const postElement=document.createElement("div");
            postElement.classList.add("col-md-6","mb-4");

            postElement.innerHTML=`
            <div class=card shadow-sm>
            <div class="card-body">
                <h2 class="card-title">
             <a href="post.html?id=${post._id}" class="post-link text-black text-decoration-none">${post.title}</a>
             </h2>
             ${post.image?`<img src="${post.image.startsWith('/uploads')?post.image:`/uploads/${post.image}`}" class="rounded mb-2" width="200px" alt="Post Image" >`:""} 
            <p class="card-text">${post.content.substring(0,100)}...</p>
            <small class="text-muted">By You|${new Date(post.createdAt).toLocaleDateString()}</small>
             <div class="d-flex align-items-center gap-2 mt-2">
             <button class="btn btn-sm btn-outline-danger like-btn" data-id="${post._id}">
             Liked By<span class="like-count">${post.likes.length}</span>
             </button>
             </div>
            <div class="mt-3">
             ${loggedInUser===post.author._id?`
             <button class="btn btn-warning btn-sm edit-btn" data-id="${post._id}">Edit</button>
             <button class="btn btn-danger btn-sm delete-btn" data-id="${post._id}">Delete</button>
            `:""}
             </div>
            </div>
            </div>`;

        const likeButton=postElement.querySelector(".like-btn")
        likeButton.addEventListener("click",function(){
        const postId=this.dataset.id;

        fetch(`/posts/${postId}/like`,{
            method:"POST",
            headers:{"Content-Type":"application/json"}
        })
        .then(res=>res.json())
        .then(data=>{
            this.querySelector(".like-count").textContent=data.likeCount
        })
        .catch(err=>{
            console.error("Error liking post:",err);
            showMessage("You must be logged in to like posts");
        });
    });
    
    //Edit button
    const editBtn=postElement.querySelector(".edit-btn");
    if(editBtn){
        editBtn.addEventListener("click",()=>{
            const postId=editBtn.dataset.id;
            window.location.href=`edit.html?id=${postId}`;
        });
    }

    //Delete button
    const deleteBtn=postElement.querySelector(".delete-btn");
if(deleteBtn){
    deleteBtn.addEventListener("click",async()=>{
        const postId=deleteBtn.dataset.id;

        const condfirmDelete=confirm("Are you sure you want to delete this post?")
        if(!confirmDelete) return;

        try{
            const res=await fetch(`/posts/${postId}`,{
                method:"DELETE"
            });

            const data=await res.json();
            if(res.ok){
                postElement.remove();//remove card from UI
                showMessage("Post deleted sucessfully","sucess");
            }else{
                showMessage(data.message||"Failed to delete post","danger");
            }
    }catch(err){
        console.error(err);
        showMessage("Server error while deleting post","danger");
    }
    });
}
            myPostsContainer.appendChild(postElement);
            
        });
    }catch(error){
        console.error("Error loading posts:",error);
    }
});
</script>
</body>
</html>