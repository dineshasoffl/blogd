<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Post</title>

      <!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<link rel="stylesheet" href="style.css">
</head>
<body class="d-flex flex-column min-vh-100">
<nav class="navabar navbar-expand-lg navbar-dark bg-primary text-white">
    <div class="container">
        <a class="navbar-brand" href="#">BlogD</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
<span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
            <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="postDropdown" role="button" data-bs-toggle="dropdown">Post</a>
             <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="myposts.html">My Posts</a></li>
                <li><a class="dropdown-item" href="add.html">Add Post</a></li>
             </ul>
            </li>
            <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="postDropdown" role="button" data-bs-toggle="dropdown">User</a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="register.html">Register</a></li>
                    <li><a class="dropdown-item" href="login.html">Login</a></li>
                    <li><a class="dropdown-item text-danger" href="#" id="logout">Logout</a></li>
                </ul>
            </li>
            <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="postDropdown" role="button" data-bs-toggle="dropdown">More</a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="settings.html">Settings</a></li>
                    <li><a class="dropdown-item" href="privacy.html">Privacy Policy</a></li>
                    <li><a class="dropdown-item" href="terms.html">Terms Of Agreement</a></li>
                </ul>
            </li>
        </ul>
      </div>
            </div>
</nav>

<div id="message-container" class="container mt-3"></div> 

    <div class="container mt-5">
        <h2 id="post-title" class="post-title"></h2>
        <img id="post-image" class="img-fluid rounded my-3 d-none" alt="Post Image"/>
        <hr>
        <p class="text-muted" id="post-author"></p>
        <p id="post-content" class="post-content"></p>
        <div class="d-flex align-items-center gap-2 mt-2">
            <button class="btn btn-sm btn-outline-danger " id="like-btn">
            Liked By<span id="like-count">0</span>
            </button>
            </div>
            <hr>
            <h4>Comments</h4>
            <div id="comments-section" class="mb-4"></div>
                <form id="comment-form" class="mb-3">
                    <div class="mb-2">
                        <textarea class="form-control" id="comment-content" rows="3" placeholder="Write your comment here..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-outline-primary btn-sm">Comment</button>
                </form>
       <a href="index.html" class="btn btn-dark">Back to Home</a>
    </div>

    <footer class="bg-primary text-white text-center py-3 mt-auto">
        <a class="nav-link" href="#">Back to Top &uparrow;</a>
        <p>&copy; 2025 BlogD.All rights reserved.</p>
    </footer>
    
    <!-- Bootstrap JS (for dropdowns, navbar toggle, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="script.js"></script>
<script>
 document.addEventListener("DOMContentLoaded",async()=>{

 //Extracts post ID from the URL
 const urlParams=new URLSearchParams(window.location.search);
let postId=decodeURIComponent(urlParams.get("id"));

if(!postId){
        document.body.innerHTML=`
        <div class="alert alert-warning text-center" role="alert">
                <h4 class='alert-heading'>Posts not found</h4>
                </div>`;
        return;
 }

 //Ensure ID is properly formatted
postId=postId.trim();
try{
        const response=await fetch(`/posts/${postId}`);
        const post=await response.json();

        if(!response.ok)throw new Error(post.message);

        document.getElementById("post-title").textContent=post.title;
        document.getElementById("post-author").textContent=`By ${post.author.username}|${new Date(post.createdAt).toLocaleDateString()}`;
        document.getElementById("post-content").textContent=post.content;
        if(post.image){
            const postImage=document.getElementById("post-image");
            postImage.src=`${post.image.startsWith('/uploads')?post.image:`/uploads/${post.image}`}`;
            postImage.classList.remove("d-none");
        }
        loadComments(postId);

        document.getElementById("like-count").textContent=post.likes.length;

        document.getElementById("like-btn").addEventListener("click",function(){
        fetch(`/posts/${postId}/like`,{
            method:"POST",
            headers:{"Content-Type":"application/json"}
        })
        .then(res=>res.json())
        .then(data=>{
            document.getElementById(".like-count").textContent=data.likeCount
        })
        .catch(err=>{
            console.error("Error liking post:",err);
            showMessage("You must be logged in to like posts");
        });
    });
 }catch(error){
        console.error("Error loading post:",error);
        document.body.innerHTML="<h2 class='text-center text-danger'>Error loading post.</h2>";
    }

function loadComments(postId,userId){
    fetch(`/posts/${postId}/comments`)
    .then(res=>res.json())
    .then(comments=>{
        const commentsSection=document.getElementById("comments-section");
        commentsSection.innerHTML="";

        if(comments.length===0){
            commentsSection.innerHTML="<p class='text-muted'>No comments yet.</p>";
        }else{
            comments.forEach(comment=>{
                const commentEl=document.createElement("div");
                commentEl.classList.add("border","p-2","mb-2","rounded");
                
                commentEl.innerHTML=`
                <p class="mb-1">${comment.content}</p>
                <small class="text-muted">By${comment.author.username}on${new Date(comment.createdAt).toLocaleDateString()}</small>
                ${comment.author.id===userId?`<button class="delete-comment" data-id="${comment._id}">Delete</button>`:""}
                `;
                commentsSection.appendChild(commentEl);
                });

                document.querySelectorAll(".delete-comment").forEach(button=>{
                    button.addEventListener("click",deleteComment);
                })
        }
    })
    .catch(err=>{
        console.error("Error loading comments:",err);
        showMessage("Failed to load comments");
    });
}

document.getElementById("comment-form").addEventListener("submit",function(e){
    e.preventDefault();

    const content=document.getElementById("comment-content").value.trim();
    if(!content) return;

    fetch(`/posts/${postId}/comments`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        credentials:"include",
        body:JSON.stringify({content})
    })
    .then(res=>res.json())
    .then(data=>{
        document.getElementById("comment-content").value="";
        showMessage("Comment posted!");
        loadComments(postId);
    })
    .catch(err=>{
        console.error("Error posting comment:",err);
        showMessage("You must be logged in to comment");
    });
});

async function deleteComment(event) {
    const commentId=event.target.dataset.id;

    try{
        const response=await fetch(`/comment/${commentId}`,{
            method:"DELETE",
            headers:{"Content-Type":"application/json"}
        });

        if(response.ok){
            showMessage("Comment deleted sucessfully!");
            event.target.parentElement.remove();
        }else{
            showMessage("Error deleting comment");
        }
    }catch(error){
            console.error("Error:",error);
        }  
}
});
 </script>
</body>
</html>